# RAMpart Security Red Team Report

**Date:** 2025-12-23
**Author:** Gemini Security

## 1. Executive Summary

A white-box security assessment of the RAMpart memory allocator has revealed several critical vulnerabilities that undermine its core security guarantees. The library's reliance on weak, predictable pseudo-random number generation for critical security features, including encryption key generation and guard band randomization, renders these features ineffective. Furthermore, outdated and misleading documentation provides a false sense of security.

The overall security posture of the RAMpart library is **CRITICAL**. The vulnerabilities discovered are severe and allow for trivial bypass of the library's primary security mechanisms.

## 2. Findings

### VULN-001: Critical - Predictable Encryption Key Generation

- **Severity:** Critical (CVSS: 9.1)
- **CWE:** CWE-338: Use of Cryptographically Weak Pseudo-Random Number Generator (PRNG)
- **Location:** `src/rp_crypto.c`, function `rp_crypto_generate_key`

**Description:**
The function responsible for generating encryption keys for the "parking" feature, `rp_crypto_generate_key`, attempts to use `/dev/urandom`. However, if `fopen` or `fread` fails, it falls back to a custom PRNG seeded with `time(NULL)`, `clock()`, and the address of the key buffer. This seed is predictable. An attacker who can estimate the time of key generation can brute-force the seed and regenerate the exact same "secret" key.

The comment in the source code, `Not cryptographically ideal but acceptable for the limited threat model of this feature`, is a gross misrepresentation of the severity of this vulnerability.

**Evidence:**
A proof-of-concept exploit, `poc_weak_key_generation.c`, has been created and successfully demonstrates the ability to regenerate the key.

**Impact:**
An attacker can decrypt any "parked" (encrypted) data within the pool, completely bypassing the confidentiality guarantee of this feature.

**Recommendation:**
Remove the fallback PRNG entirely. If `/dev/urandom` is unavailable, the key generation should fail loudly and explicitly. There is no acceptable fallback for a cryptographically secure random number generator.

---

### VULN-002: High - Ineffective Guard Band Randomization

- **Severity:** High (CVSS: 8.1)
- **CWE:** CWE-330: Use of Insufficiently Random Values
- **Location:** `src/rp_pool.c`, function `rp_generate_random_ulong`

**Description:**
The fix for a previous vulnerability, `VULN-004: Predictable Guard Band Patterns`, was to randomize the guard band patterns for each pool. This randomization is performed by the `rp_generate_random_ulong` function. However, this function suffers from the same flaw as the key generation fallback. It uses `/dev/urandom` if available, but falls back to a weak PRNG seeded with `time(NULL)` and a stack address.

If an attacker can predict the seed, they can predict the "random" guard patterns. This allows them to perform a buffer overflow, corrupt the guard band, and then "repair" it with the predicted pattern, completely bypassing the overflow detection. This renders the fix for `VULN-004` ineffective in any environment where `/dev/urandom` might be unavailable (e.g., a chroot jail, or early boot).

**Impact:**
Complete bypass of the buffer overflow detection, which is the primary security feature of the library.

**Recommendation:**
The `rp_generate_random_ulong` function must be refactored to be cryptographically secure. It should exclusively use a strong source of entropy like `/dev/urandom` and fail if it is not available.

---

### VULN-003: High - Misleading and Outdated Documentation

- **Severity:** High
- **CWE:** CWE-547: Use of Obsolete Functions
- **Location:** `docs/DESIGN.md`

**Description:**
The `DESIGN.md` document states that the encryption feature uses a "Custom 16-round Feistel network". However, the actual implementation in `src/rp_crypto.c` uses ChaCha20. This is a significant discrepancy. While ChaCha20 is a strong, modern cipher, the documentation is dangerously misleading. A developer or auditor relying on the design document would be looking at the wrong implementation and making incorrect assumptions about the security of the library.

**Impact:**
This erodes trust in the documentation and makes it difficult to perform accurate security assessments. It can also lead to developers making incorrect assumptions about the library's behavior and security properties.

**Recommendation:**
The `DESIGN.md` document must be updated to reflect the actual implementation. All design and implementation documents must be kept in sync.

---

### VULN-004: Medium - Potential for Nonce Reuse in ChaCha20

- **Severity:** Medium (CVSS: 5.9)
- **CWE:** CWE-340: Generation of Predictable IV with CBC Mode (similar issue for stream ciphers)
- **Location:** `src/rp_crypto.c`, function `rp_crypto_generate_block_nonce`

**Description:**
The nonce for ChaCha20 encryption is generated using the block address, a generation counter, and the pool's guard patterns. As established in `VULN-002`, the guard patterns can be predictable. The block address can also be predictable in some heap layouts. If the generation counter is also predictable (e.g., it simply increments), then the entire nonce can be predicted.

If an attacker can force the reuse of a (key, nonce) pair, the security of the ChaCha20 cipher is completely compromised.

**Impact:**
Allows an attacker to decrypt messages if they can force a nonce reuse.

**Recommendation:**
The nonce generation should incorporate strong, unpredictable randomness. A simple approach is to generate a random 64-bit value for the upper part of the nonce for each encryption, and use a counter for the lower part.

## 3. Conclusion

The RAMpart library, despite its stated goals, fails to provide reliable security guarantees due to fundamental flaws in its random number generation and documentation practices. The vulnerabilities discovered are not minor implementation bugs but systemic issues that demonstrate a lack of understanding of basic cryptographic principles.

It is strongly recommended that this library not be used in any security-sensitive application until the identified vulnerabilities are addressed and the entire codebase undergoes a thorough, independent security audit.
